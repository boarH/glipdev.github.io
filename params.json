{"name":"GlipDev: Double Meat","tagline":"All the goings ons in glip development land, plus a heavy dose of the caveman diet.","body":"#Disable Superfish on Your Site \r\n_by: @brettpaden_\r\n\r\nWith all the recent attention to the superfish/Lenovo scandal I thought I would share our experience with the fallout from this malware and show developers and site maintainers a simple solution to stop the injected code from Superfish's malware from working on your site (well, at least until they patch it :-)).\r\n\r\n##TL;DR\r\nPut his in the head section of your web pages:\r\n```html\r\n     <meta name=\"superfish\" content=\"nofish\">\r\n```\r\n\r\n##The Story\r\nI work at [Glip](https://glip.com), an enterprise communications platform that competes with the likes of Slack, Asana, HipChat and Flowdock. Sometime in early December we started getting reports from customers that Glip simply ceased functioning for them … on all browsers … on their new laptops.\r\n\r\nSomething was fishy (ehhhhheheheheh) and I requested a TeamViewer session with one of our more helpful customers.\r\n\r\nI saw from the console that malware of some kind was injecting javascript into every single site requested. The injected javascript pulled in some code from best-deals-products.com (specifically https://www.best-deals-products.com/ws/sf_main.jsp?dlsource=hdrykzc). The script was crashing for some reason and halting javascript execution on the page.\r\n\r\nCrap, I thought, now my team has to figure out how to unfuck some asshole's malware so our web app works properly.\r\n\r\nWe downloaded the source for sf_main.jsp, manually injected it into a sandbox instance of our app and started stack tracing.  This jumped out immediately:\r\n\r\n```javascript\r\n//if (false && location.protocol === 'https:' && queryString.search(/dlsource=hdrykzc/i) !== -1) // Patch for Lenovo - do not run on https sites\r\nif (queryString.search(/dlsource=hdrykzc/i) !== -1) // Disable Lenovo users\r\n{\r\n    return;\r\n}\r\n```\r\n\r\nWTF.  Hardware vendor specific instructions???\r\n\r\nMind you, we hadn't deduced anything about the model of new laptops our users had, but immediately asked.  Why yes, said our customer, it is a Lenovo.   Ironically this little bit of code intended to disable the best-deals script wasn't working as intended, leading to another error later in the stack.\r\n\r\nFrom this code and comment it's pretty clear that there was some level of collusion between Lenovo and Superfish; either Lenovo requested the malware to be disabled or Superfish tried to mitigate its impact in an effort not to get caught. But I digress ... we still had to figure out something for our customers.\r\n\r\nGiving them malware removal instructions or telling them to install a particular anti-virus wasn't really an option. (we later learned simply uninstalling Superfish software removes the malware as well).  But our main concern was all the users that had not or would not contact our customer service. You know the old rule: for every bug report there are at least 10X people more out there feeling the pain but not reporting it.\r\n\r\nOne of our devs known simply as Beard (also the source of his hacker prowess and ability to brew beer) had the brilliant idea of reading sf_main from the beginning.  Lo, it was was revealed unto him:\r\n\r\n```javascript\r\nvar nofish = false;\r\nvar metaTags = document.getElementsByTagName('meta');\r\nvar metaTag;\r\n\r\nfor (var i=0, l=metaTags.length; i<l; i++)\r\n{\r\n     metaTag = metaTags[i];\r\n\r\n     if (metaTag.getAttribute('name') && metaTag.getAttribute('name').toLowerCase() == 'superfish' && metaTag.getAttribute('content') && metaTag.ge    tAttribute('content').toLowerCase() == 'nofish')\r\n    {\r\n        nofish = true;\r\n        break;\r\n    }\r\n}\r\n```\r\nLater in the code there are instruction to simply stop executing if nofish was true.  We could pre-emptively disable the injected code from running with the addition of a simple meta tag.\r\n\r\n```html\r\n     <meta name=\"superfish\" content=\"nofish\">\r\n```\r\n\r\nHope this helps any web developers who are having to contend with this.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}